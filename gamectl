#! /bin/bash
ROOT=`cd $(dirname $0); pwd`
CONFDIR=$ROOT/etc
LOGDIR=$ROOT/log

# å®šä¹‰erlang vmé€‰é¡¹
ERL=erl
POLL=true
ASYNC=8
SMP=enable
ERL_PROCESSES=500000
CONNECT_ALL=true
DATETIME=`date "+%Y%m%d-%H%M%S"`
export ERL_CRASH_DUMP=$ROOT/erl_crash_$DATETIME.dump
export ERL_MAX_PORTS=102400
export ERL_MAX_ETS_TABLES=10000
export HOME=$ROOT
SYSTEM_CONFIG=$CONFDIR/system.config

# å…¶å®ƒå˜é‡
ERLANG_NODE=xs_game@192.168.1.120
COOKIE="node-cookie"
WORLD_NODE=
# åœ°å›¾èŠ‚ç‚¹å¯åŠ¨çš„åœ°å›¾
AREA_MAP="[]"

# è¿è¡Œçš„ç¨‹åºåŠæ§åˆ¶æ–‡ä»¶
APP_MOD=game
APP_CTL=game_ctl
ERROR_LOG=$LOGDIR/game.log
SASL_LOG=$LOGDIR/game_`date +%Y%m%d`.sasl

# define additional environment variables
EBINS="$ROOT/ebin $ROOT/deps/ebin"
#echo "ebins is " $EBINS

# makesure the logs dir exists
if [ ! -d $LOGDIR ]; then
    mkdir -p $LOGDIR || echo "make $LOGDIR error!"; exit 1
fi

STATUS_SUCCESS=0    # æˆåŠŸ
STATUS_AGAIN=1      # è¿›è¡Œä¸­,è¯·é‡è¯•
STATUS_USAGE=2      # ä½¿ç”¨é”™è¯¯
STATUS_BADRPC=3     # rpcè°ƒç”¨é”™è¯¯
STATUS_ERROR=4      # å…¶å®ƒé”™è¯¯

# é‡æ–°åŠ è½½çš„ç³»ç»Ÿæ•°æ®
RELOAD_TYPE=all_data

# æ‰“å°é”™è¯¯
error() {
    echo -e "[1;41m[é”™è¯¯][0m $1"
    exit 1
}

# æ‰“å°ä¿¡æ¯
echo2() {
    echo -e "[1;42m[æ“ä½œ][0m $1"
}

# æ‰“å°è­¦å‘Š
warn() {
    echo -e "[1;43m[è­¦å‘Š][0m $1"
}

# è·å–å†…ç½‘ip
getip() {
    echo `LANG=en_US; ifconfig | grep 'inet addr:' | grep -v '127.0.0.1' | grep '192.*' | cut -d: -f 2 | awk '{print $1}'`
}

# ä½¿ç”¨è¯´æ˜
usage ()
{
    echo ""
    echo "ç”¨æ³•:"
    echo "$0 ACTION [OPTION]"
    echo "ACTION:"
    echo "  live        äº¤äº’æ–¹å¼å¯åŠ¨"
    echo "  start       åå°æ–¹å¼å¯åŠ¨"
    echo "  status      è·å–åå°è¿è¡ŒçŠ¶æ€"
    echo "  attach      é€šè¿‡Erlang shellè¿æ¥åå°è¿è¡ŒèŠ‚ç‚¹"
    echo "  stop        åœæ­¢èŠ‚ç‚¹"
    echo "  restart     é‡å¯èŠ‚ç‚¹"
    echo "  reload      é‡æ–°åŠ è½½æ•°æ®æˆ–ä»£ç "
    echo ""
    echo "OPTION:"
    echo "  -h, --help              æ˜¾ç¤ºæœ¬ä¿¡æ¯"
    echo "  -n, --node=Nodename     èŠ‚ç‚¹åç§°:$ERLANG_NODE(default)"
    echo "  -c, --cookie=Cookie     èŠ‚ç‚¹cookie(é»˜è®¤\"\")"
    echo "  -f, --conf=Conf         æŒ‡æ˜ä½¿ç”¨çš„é…ç½®æ–‡ä»¶(é»˜è®¤gh.conf)"
    echo "  -r, --reload=Type       æŒ‡æ˜è¦reloadçš„ç³»ç»Ÿæ•°æ®:code,config,all_data,æŒ‡å®šçš„æ•°æ®å¦‚goods(é»˜è®¤all_data)"
    echo "  -w, --world=World       æŒ‡æ˜worldèŠ‚ç‚¹,ä¸ºgate,areaèŠ‚ç‚¹æ—¶éœ€è¦æŒ‡æ˜æ­¤å‚æ•°"
    echo ""
}

# ä¿®æ”¹ulimit
change_ulimit() {
    if ! ulimit -HSn 102400 2> /dev/null ; then
        error "è¯·ç¡®ä¿å…·æœ‰rootæƒé™"
    fi
}

# æŸ¥è¯¢è¿è¡Œä¸­èŠ‚ç‚¹çš„ä¿¡æ¯
rpc() 
{
    $ERL \
      $NAME_FLAG game_ctl@$HOST \
      -noinput \
      -pa $EBINS \
      -config $SYSTEM_CONFIG \
      -setcookie ${COOKIE} \
      -s ${APP_CTL} -extra $ERLANG_NODE $@
}

# æ‰“å°rpcè¿”å›ä¿¡æ¯
print_rpc_return ()
{
    case $1 in
    $STATUS_SUCCESS) 
        echo ""
        ;;
    $STATUS_AGAIN) 
        warn "è¿›è¡Œä¸­,è¯·é‡è¯•!"
        ;;
    $STATUS_USAGE) 
        error "å‘½ä»¤ä¸æ”¯æŒ! $0 -hæŸ¥çœ‹å¸®åŠ©"
        ;;
    $STATUS_BADRPC) 
        error "èŠ‚ç‚¹$ERLANG_NODEæœªè¿è¡Œ"
        ;;
    *)
        error "æœªçŸ¥å‘½ä»¤! $0 -hæŸ¥çœ‹å¸®åŠ©"
    esac
}

# åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿è¡Œ
is_started () 
{
    if [ "$APP_MOD" = "game" ]; then
        rpc status
    else
        rpc status $APP_MOD
    fi
    result=$?
    if [  "$result" = "$STATUS_SUCCESS" ]; then
        return 0
    fi
    return 1
}

# start interactive server
live ()
{
    change_ulimit
    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -pa $EBINS \
      -config $SYSTEM_CONFIG \
      -setcookie ${COOKIE} \
      -kernel dist_auto_connect never \
      -s ${APP_MOD} start \
      $ERLANG_OPTS -extra $ARGS "$@"
}

# å¯åŠ¨server
start ()
{
    change_ulimit
    if is_started; then
        warn "èŠ‚ç‚¹$ERLANG_NODEå·²ç»å¯åŠ¨"
        exit 0
    fi

    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -noinput -detached \
      -pa $EBINS \
      -setcookie ${COOKIE} \
      -kernel dist_auto_connect never \
      -kernel error_logger \{file,\"$ERROR_LOG\"\} \
      -sasl sasl_error_logger \{file,\"$SASL_LOG\"\} \
      -s ${APP_MOD} start\
      $ERLANG_OPTS $ARGS "$@"
    
    RETRY=0
    while [ $RETRY -lt 60 ];do
        if [ $? -ne 0 ]; then
            error "èŠ‚ç‚¹$ERLANG_NODEå¯åŠ¨å¤±è´¥:$?"
        else
            if is_started; then
                break
            else
                let RETRY++
                sleep 1
            fi
            if [ $RETRY -ge 30 ]; then
                warn "*****************æœåŠ¡å™¨$APP_NAMEå¯åŠ¨å¤±è´¥,è¯·æ‰‹åŠ¨æ£€æŸ¥**************"
                exit 1
            fi
        fi
    done
    echo2 "èŠ‚ç‚¹$ERLANG_NODEå¯åŠ¨æˆåŠŸ!"
}

# è·å–çŠ¶æ€
status ()
{
    if is_started; then
        echo2 "èŠ‚ç‚¹$ERLANG_NODEçŠ¶æ€: è¿è¡Œä¸­"
    else
        print_rpc_return $?
    fi  
}

# è¿æ¥åˆ°èŠ‚ç‚¹å†…
attach ()
{
    if ! is_started; then
        error "èŠ‚ç‚¹$ERLANG_NODEæœªå¯åŠ¨"
    fi
    $ERL \
      $NAME_FLAG ${NAME}debug@$HOST \
      -setcookie ${COOKIE} \
      -hidden \
      -remsh $ERLANG_NODE \
      $ERLANG_OPTS $ARGS "$@"
}

# åœæ­¢èŠ‚ç‚¹
stop ()
{
    if rpc stop; then
        echo2 "èŠ‚ç‚¹$ERLANG_NODEåœæ­¢: æˆåŠŸ"
    else
        print_rpc_return $?
    fi  
}

# åœæ­¢socketç›‘å¬
stopsock ()
{
    if rpc stopsock; then
        echo2 "èŠ‚ç‚¹$ERLANG_NODEåœæ­¢Socketç›‘å¬: æˆåŠŸ"
    else
        print_rpc_return $?
    fi  
}



# é‡å¯èŠ‚ç‚¹
restart ()
{
    if rpc restart; then
        echo2 "èŠ‚ç‚¹$ERLANG_NODEé‡å¯: æˆåŠŸ"
    else
        print_rpc_return $?
    fi  
}

# é‡æ–°åŠ è½½
reload ()
{
    if rpc reload ${RELOAD_TYPE} > /dev/null; then
        echo2 "èŠ‚ç‚¹$ERLANG_NODEé‡æ–°åŠ è½½${RELOAD_TYPE}æˆåŠŸ"
    else
        error "èŠ‚ç‚¹$ERLANG_NODEé‡æ–°åŠ è½½${RELOAD_TYPE}å¤±è´¥"
    fi  
}

# è¿½è¸ª
peer ()
{
    if rpc peer ${PEER_ID}; then
        echo2 "èŠ‚ç‚¹$ERLANG_NODEè¿½è¸ª${PEER_ID}æˆåŠŸ"
    else
        error "èŠ‚ç‚¹$ERLANG_NODEè¿½è¸ª${PEER_ID}å¤±è´¥"
    fi  
}

# è§£é™¤è¿½è¸ª
unpeer ()
{
    if rpc unpeer ${PEER_ID}; then
        echo2 "èŠ‚ç‚¹$ERLANG_NODEè§£é™¤è¿½è¸ª${PEER_ID}æˆåŠŸ"
    else
        error "èŠ‚ç‚¹$ERLANG_NODEè§£é™¤è¿½è¸ª${PEER_ID}å¤±è´¥"
    fi  
}

# parse command line parameters
while [ $# -ne 0 ] ; do
    PARAM=$1
    shift
    case $PARAM in
        --) break ;;
        --node|-n) ERLANG_NODE=$1; shift ;;
        --cookie|-c) COOKIE=$1 ; shift ;;
        --conf|-f) export GAME_CONF_FILE=$1 ; shift ;;
        --help|-h) usage; exit 0;;
        --reload|-r) RELOAD_TYPE=$1; shift;;
        --peer|-p) PEER_ID=$1; shift;;
        --world|-w) WORLD_NODE=$1; shift;;
        *) ARGS="$ARGS $PARAM" ;;
    esac
done

NAME=${ERLANG_NODE%%@*}
HOST=${ERLANG_NODE##*@}
NAME_FLAG=-name
[ "$ERLANG_NODE" = "${ERLANG_NODE%.*}" ] && NAME_FLAG=-sname

# æ£€æµ‹worldå‚æ•°
if [ "$APP_MOD" = "area_app" -o "$APP_MOD" = "gate_app" ]; then
    [ -z "$WORLD_NODE" ] && error "è¯·è®¾ç½®-w(--world)å‚æ•°"
fi

#ERLANG_OPTS="-connect_all $CONNECT_ALL +K $POLL -smp $SMP +P $ERL_PROCESSES \
#    +t 10485760 +fnu +hms 8192 +hmbs 8192 +zdbbl 81920"

ERLANG_OPTS="-connect_all $CONNECT_ALL +K $POLL -smp $SMP +P $ERL_PROCESSES \
    +t 67108864 +fnu +zdbbl 81920"


case $ARGS in
    '') usage;;
    ' live') live;;
    ' start') start;;
    ' status') status;;
    ' attach') attach;;
    ' stop') stop;;
    ' stopsock') stopsock;;
    ' restart') restart;;
    ' reload') reload;;
    ' peer') peer;;
    ' unpeer') unpeer;;
    *) usage; exit 1;;
esac

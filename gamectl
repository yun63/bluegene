#! /bin/bash
ROOT=`cd $(dirname $0); pwd`
CONF_DIR=$ROOT/etc
LOG_DIR=$ROOT/log
SYSTEM_CONFIG=$CONF_DIR/sys.config

# ÂÆö‰πâerlang vmÈÄâÈ°π
ERL=erl
NAME_FLAG=-name
POLL_FLAG=true
SMP_FLAG=enable
CONNECT_ALL_FLAG=true
ASYNC=8
ERL_PROCESSES=500000
DATETIME=`date "+%Y%m%d-%H%M%S"`

export ERL_CRASH_DUMP=$ROOT/erl_crash_$DATETIME.dump
export ERL_MAX_PORTS=102400
export ERL_MAX_ETS_TABLES=10000

# ÂÖ∂ÂÆÉÂèòÈáè
ERLANG_NODE=bluegene@10.10.10.116
COOKIE="node-cookie"

# ËøêË°åÁöÑÁ®ãÂ∫èÂèäÊéßÂà∂Êñá‰ª∂
APP_MOD=game_ctrl
APP_CTL=game_ctrl
GAME_LOG=$LOG_DIR/game.log
SASL_LOG=$LOG_DIR/game_`date +%Y%m%d`.sasl

# define additional environment variables
EBINS="$ROOT/ebin $ROOT/deps/*/ebin $ROOT/apps/*/ebin"

# make sure the logs dir exists
if [ ! -d $LOG_DIR ]; then
    mkdir -p $LOG_DIR || echo "make $LOG_DIR error!"; exit 1
fi

STATUS_SUCCESS=0    # ÊàêÂäü
STATUS_AGAIN=1      # ËøõË°å‰∏≠,ËØ∑ÈáçËØï
STATUS_USAGE=2      # ‰ΩøÁî®ÈîôËØØ
STATUS_BADRPC=3     # rpcË∞ÉÁî®ÈîôËØØ
STATUS_ERROR=4      # ÂÖ∂ÂÆÉÈîôËØØ

# ÈáçÊñ∞Âä†ËΩΩÁöÑÁ≥ªÁªüÊï∞ÊçÆ
RELOAD_TYPE=all_data

# ÊâìÂç∞ÈîôËØØ
error() {
    echo -e "[1;41m[ÈîôËØØ][0m $1"
    exit 1
}

# ÊâìÂç∞‰ø°ÊÅØ
echo2() {
    echo -e "[1;42m[Êìç‰Ωú][0m $1"
}

# ÊâìÂç∞Ë≠¶Âëä
warn() {
    echo -e "[1;43m[Ë≠¶Âëä][0m $1"
}

# Ëé∑ÂèñÂÜÖÁΩëip
getip() {
    echo `LANG=en_US; ifconfig | grep 'inet addr:' | grep -v '127.0.0.1' | grep '192.*' | cut -d: -f 2 | awk '{print $1}'`
}

# ‰ΩøÁî®ËØ¥Êòé
usage ()
{
    echo ""
    echo "Áî®Ê≥ï:"
    echo "$0 ACTION [OPTION]"
    echo "ACTION:"
    echo "  live        ‰∫§‰∫íÊñπÂºèÂêØÂä®"
    echo "  start       ÂêéÂè∞ÊñπÂºèÂêØÂä®"
    echo "  status      Ëé∑ÂèñÂêéÂè∞ËøêË°åÁä∂ÊÄÅ"
    echo "  attach      ÈÄöËøáErlang shellËøûÊé•ÂêéÂè∞ËøêË°åËäÇÁÇπ"
    echo "  stop        ÂÅúÊ≠¢ËäÇÁÇπ"
    echo "  restart     ÈáçÂêØËäÇÁÇπ"
    echo "  reload      ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÊàñ‰ª£Á†Å"
    echo ""
    echo "OPTION:"
    echo "  -h, --help              ÊòæÁ§∫Êú¨‰ø°ÊÅØ"
    echo "  -n, --node=Nodename     ËäÇÁÇπÂêçÁß∞:$ERLANG_NODE(default)"
    echo "  -c, --cookie=Cookie     ËäÇÁÇπcookie(ÈªòËÆ§\"\")"
    echo "  -f, --conf=Conf         ÊåáÊòé‰ΩøÁî®ÁöÑÈÖçÁΩÆÊñá‰ª∂(ÈªòËÆ§gh.conf)"
    echo "  -r, --reload=Type       ÊåáÊòéË¶ÅreloadÁöÑÁ≥ªÁªüÊï∞ÊçÆ:code,config,all_data,ÊåáÂÆöÁöÑÊï∞ÊçÆÂ¶Çgoods(ÈªòËÆ§all_data)"
    echo ""
}

# Êü•ËØ¢ËøêË°å‰∏≠ËäÇÁÇπÁöÑ‰ø°ÊÅØ
rpc() 
{
    $ERL \
      $NAME_FLAG game_ctl@$HOST \
      -noinput \
      -pa $EBINS \
      -config $SYSTEM_CONFIG \
      -setcookie ${COOKIE} \
      -s game_ctrl -extra $ERLANG_NODE $@
}

# ÊâìÂç∞rpcËøîÂõû‰ø°ÊÅØ
print_rpc_return ()
{
    case $1 in
    $STATUS_SUCCESS) 
        echo ""
        ;;
    $STATUS_AGAIN) 
        warn "ËøõË°å‰∏≠,ËØ∑ÈáçËØï!"
        ;;
    $STATUS_USAGE) 
        error "ÂëΩ‰ª§‰∏çÊîØÊåÅ! $0 -hÊü•ÁúãÂ∏ÆÂä©"
        ;;
    $STATUS_BADRPC) 
        error "ËäÇÁÇπ$ERLANG_NODEÊú™ËøêË°å"
        ;;
    *)
        error "Êú™Áü•ÂëΩ‰ª§! $0 -hÊü•ÁúãÂ∏ÆÂä©"
    esac
}

# Âà§Êñ≠ËäÇÁÇπÊòØÂê¶ËøêË°å
is_started () 
{
    rpc status game_ctrl
    result=$?
    if [  "$result" = "$STATUS_SUCCESS" ]; then
        return 0
    fi
    return 1
}

# start interactive server
debug()
{
    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -pa $EBINS \
      -config $SYSTEM_CONFIG \
      -setcookie ${COOKIE} \
      -kernel dist_auto_connect never \
      -s game_ctrl start \
      $ERLANG_OPTS -extra $ARGS "$@"
}

# ÂêØÂä®server
start ()
{
    if is_started; then
        warn "ËäÇÁÇπ$ERLANG_NODEÂ∑≤ÁªèÂêØÂä®"
        exit 0
    fi

    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -noinput -detached \
      -pa $EBINS \
      -setcookie ${COOKIE} \
      -kernel dist_auto_connect never \
      -kernel error_logger \{file,\"$GAME_LOG\"\} \
      -sasl sasl_error_logger \{file,\"$SASL_LOG\"\} \
      -s game_ctrl start\
      $ERLANG_OPTS $ARGS "$@"
    
    RETRY=0
    while [ $RETRY -lt 60 ];do
        if [ $? -ne 0 ]; then
            error "ËäÇÁÇπ$ERLANG_NODEÂêØÂä®Â§±Ë¥•:$?"
        else
            if is_started; then
                break
            else
                let RETRY++
                sleep 1
            fi
            if [ $RETRY -ge 30 ]; then
                warn "*****************ÊúçÂä°Âô®game_ctrlÂêØÂä®Â§±Ë¥•,ËØ∑ÊâãÂä®Ê£ÄÊü•**************"
                exit 1
            fi
        fi
    done
    echo2 "ËäÇÁÇπ$ERLANG_NODEÂêØÂä®ÊàêÂäü!"
}

# Ëé∑ÂèñÁä∂ÊÄÅ
status ()
{
    if is_started; then
        echo2 "ËäÇÁÇπ$ERLANG_NODEÁä∂ÊÄÅ: ËøêË°å‰∏≠"
    else
        print_rpc_return $?
    fi  
}

# ËøûÊé•Âà∞ËäÇÁÇπÂÜÖ
attach ()
{
    if ! is_started; then
        error "ËäÇÁÇπ$ERLANG_NODEÊú™ÂêØÂä®"
    fi
    TTY=`tty | sed -e  's/.*\///g'`
    $ERL \
      $NAME_FLAG debug-${TTY}-${ERLANG_NODE} \
      -setcookie ${COOKIE} \
      -hidden \
      -remsh $ERLANG_NODE \
      $ERLANG_OPTS $ARGS "$@"
}

# ÂÅúÊ≠¢ËäÇÁÇπ
stop ()
{
    if rpc stop; then
        echo2 "ËäÇÁÇπ$ERLANG_NODEÂÅúÊ≠¢: ÊàêÂäü"
    else
        print_rpc_return $?
    fi  
}

# ÂÅúÊ≠¢socketÁõëÂê¨
stopsock ()
{
    if rpc stopsock; then
        echo2 "ËäÇÁÇπ$ERLANG_NODEÂÅúÊ≠¢SocketÁõëÂê¨: ÊàêÂäü"
    else
        print_rpc_return $?
    fi  
}



# ÈáçÂêØËäÇÁÇπ
restart ()
{
    if rpc restart; then
        echo2 "ËäÇÁÇπ$ERLANG_NODEÈáçÂêØ: ÊàêÂäü"
    else
        print_rpc_return $?
    fi  
}

# ÈáçÊñ∞Âä†ËΩΩ
reload ()
{
    if rpc reload ${RELOAD_TYPE} > /dev/null; then
        echo2 "ËäÇÁÇπ$ERLANG_NODEÈáçÊñ∞Âä†ËΩΩ${RELOAD_TYPE}ÊàêÂäü"
    else
        error "ËäÇÁÇπ$ERLANG_NODEÈáçÊñ∞Âä†ËΩΩ${RELOAD_TYPE}Â§±Ë¥•"
    fi  
}

DEBUG_NAME=${ERLANG_NODE%%@*}
HOST=${ERLANG_NODE##*@}
NAME_FLAG=-name

ERLANG_OPTS="-connect_all $CONNECT_ALL_FLAG +K $POLL_FLAG -smp $SMP_FLAG +P $ERL_PROCESSES \
    +t 67108864 +fnu +zdbbl 81920"

case $1 in
    '') usage;;
    ' debug') debug;;
    ' start') start;;
    ' status') status;;
    ' attach') attach;;
    ' stop') stop;;
    ' stopsock') stopsock;;
    ' restart') restart;;
    ' reload') reload;;
    *) usage; exit 1;;
esac
